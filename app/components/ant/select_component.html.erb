<div class="relative w-full <%= @html_options[:class] %>" 
     data-controller="ant--select"
     data-ant--select-multiple-value="<%= @multiple %>"
     data-ant--select-searchable-value="<%= @searchable %>"
     data-ant--select-max-tag-count-value="<%= @max_tag_count || 0 %>"
     data-placeholder="<%= @placeholder %>">
  
  <!-- Hidden Input(s) -->
  <% if @multiple %>
    <% @selected.each do |val| %>
      <input type="hidden" name="<%= @name %>[]" value="<%= val %>" data-ant--select-target="input">
    <% end %>
    <!-- Keep at least one empty input for form submission when nothing selected -->
    <input type="hidden" name="<%= @name %>[]" value="" data-ant--select-target="emptyInput" <%= 'disabled' unless @selected.empty? %>>
  <% else %>
    <input type="hidden" name="<%= @name %>" value="<%= @selected.first %>" data-ant--select-target="input" <%= "disabled" if @disabled %>>
  <% end %>

  <!-- Trigger -->
  <button type="button" 
          data-action="click->ant--select#toggle" 
          data-ant--select-target="trigger"
          class="w-full text-left flex items-center justify-between px-[11px] py-[4px] min-h-[32px] text-[14px] rounded-[6px] border transition-all outline-none bg-white 
                 <%= @disabled ? 'bg-[#f5f5f5] border-[#d9d9d9] cursor-not-allowed text-[rgba(0,0,0,0.25)]' : 'border-[#d9d9d9] hover:border-[#4096ff] focus:border-[#4096ff] focus:shadow-[0_0_0_2px_rgba(5,145,255,0.1)] cursor-pointer text-[rgba(0,0,0,0.88)]' %>"
          <%= "disabled" if @disabled %>>
    
    <span class="truncate block flex-1 flex items-center gap-1 flex-wrap" data-ant--select-target="label">
      <% if @multiple && !@selected.empty? %>
        <!-- Multiple: Show Tags (render all, hide excess with !important style initially) -->
        <% selected_tags.each_with_index do |tag, index| %>
          <% should_hide = @max_tag_count && @max_tag_count > 0 && index >= @max_tag_count %>
          <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-[#f5f5f5] border border-[#d9d9d9] rounded text-[12px]" 
                data-value="<%= tag[:value] %>"
                <%= 'style="display: none !important;"'.html_safe if should_hide %>>
            <%= tag[:label] %>
            <% unless @disabled %>
              <svg data-action="click->ant--select#removeTag" 
                   data-value="<%= tag[:value] %>"
                   class="w-3 h-3 text-[rgba(0,0,0,0.45)] hover:text-[rgba(0,0,0,0.88)] cursor-pointer" 
                   viewBox="64 64 896 896" fill="currentColor">
                <path d="M563.8 512l262.5-312.9c4.4-5.2.7-13.1-6.1-13.1h-79.8c-4.7 0-9.2 2.1-12.3 5.7L511.6 449.8 295.1 191.7c-3-3.6-7.5-5.7-12.3-5.7H203c-6.8 0-10.5 7.9-6.1 13.1L459.4 512 196.9 824.9A7.95 7.95 0 00203 838h79.8c4.7 0 9.2-2.1 12.3-5.7l216.5-258.1 216.5 258.1c3 3.6 7.5 5.7 12.3 5.7h79.8c6.8 0 10.5-7.9 6.1-13.1L563.8 512z"/>
              </svg>
            <% end %>
          </span>
        <% end %>
        <% if overflow_count > 0 %>
          <span class="overflow-tag inline-flex items-center px-2 py-0.5 bg-[#f5f5f5] border border-[#d9d9d9] rounded text-[12px]">
            +<%= overflow_count %>
          </span>
        <% end %>
      <% else %>
        <!-- Single or Placeholder -->
        <%= selected_label %>
      <% end %>
    </span>
    
    <!-- Loading or Arrow Icon -->
    <span class="text-[rgba(0,0,0,0.25)] text-[12px] flex items-center justify-center pointer-events-none ml-2">
      <% if @loading %>
        <!-- Loading Spinner -->
        <svg class="animate-spin" viewBox="0 0 1024 1024" width="1em" height="1em" fill="currentColor">
          <path d="M988 548c-19.9 0-36-16.1-36-36 0-59.4-11.6-117-34.6-171.3a440.45 440.45 0 00-94.3-139.9 437.71 437.71 0 00-139.9-94.3C629 83.6 571.4 72 512 72c-19.9 0-36-16.1-36-36s16.1-36 36-36c69.1 0 136.2 13.5 199.3 40.3C772.3 66 827 103 874 150c47 47 83.9 101.8 109.7 162.7 26.7 63.1 40.2 130.2 40.2 199.3.1 19.9-16 36-35.9 36z"/>
        </svg>
      <% else %>
        <!-- Arrow Icon -->
        <svg data-ant--select-target="arrow" viewBox="0 0 1024 1024" width="1em" height="1em" fill="currentColor">
          <path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3 0.1-12.7-6.4-12.7z"/>
        </svg>
      <% end %>
    </span>
  </button>

  <!-- Dropdown Panel -->
  <div data-ant--select-target="panel" 
       class="hidden absolute z-50 min-w-full mt-1 bg-white rounded-lg overflow-hidden origin-top-left
              shadow-[0_3px_6px_-4px_rgba(0,0,0,0.12),0_6px_16px_0_rgba(0,0,0,0.08),0_9px_28px_8px_rgba(0,0,0,0.05)]">
    
    <!-- Search Box (if searchable) -->
    <% if @searchable %>
      <div class="p-2 border-b border-gray-200">
        <input type="text" 
               data-ant--select-target="search"
               data-action="input->ant--select#filterOptions"
               placeholder="Search..."
               class="w-full px-3 py-1.5 text-[14px] border border-[#d9d9d9] rounded-[6px] outline-none focus:border-[#4096ff] focus:shadow-[0_0_0_2px_rgba(5,145,255,0.1)]">
      </div>
    <% end %>
    
    <!-- Options List -->
    <div class="p-1 overflow-y-auto max-h-[256px] scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent hover:scrollbar-thumb-gray-400">
      <ul class="text-[14px] text-gray-700">
        <% @options.each do |label, value| %>
          <% is_selected = is_selected?(value.to_s) %>
          <li data-action="click->ant--select#select" 
              data-value="<%= value %>"
              data-label="<%= label %>"
              data-ant--select-target="option"
              class="px-3 py-1.5 rounded-[4px] cursor-pointer transition-colors flex items-center justify-between
                     <%= is_selected ? 'bg-[#e6f4ff] font-semibold text-gray-900' : 'hover:bg-[#f5f5f5]' %>">
            <span><%= label %></span>
            
            <!-- Check Icon for Selected -->
            <% if is_selected %>
               <svg class="text-[#1677ff]" viewBox="64 64 896 896" width="1em" height="1em" fill="currentColor">
                 <path d="M912 190h-69.9c-9.8 0-19.1 4.5-25.1 12.2L404.7 724.5 207 474a32 32 0 00-25.1-12.2H112c-6.7 0-10.4 7.7-6.3 12.9l273.9 347c12.8 16.2 37.4 16.2 50.3 0l488.4-618.9c4.1-5.1.4-12.8-6.3-12.8z"/>
               </svg>
            <% end %>
          </li>
        <% end %>
      </ul>
      
      <!-- No Results Message -->
      <div data-ant--select-target="noResults" class="hidden px-3 py-4 text-center text-[rgba(0,0,0,0.25)] text-[14px]">
        No results found
      </div>
    </div>
  </div>
</div>
