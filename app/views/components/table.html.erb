<%= render Ui::ComponentHeaderComponent.new(
  title: "Table è¡¨æ ¼",
  description: "å±•ç¤ºè¡Œåˆ—æ•°æ®ã€‚",
  when_to_use: ["å½“æœ‰å¤§é‡ç»“æ„åŒ–çš„æ•°æ®éœ€è¦å±•ç°æ—¶ã€‚", "éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ’åºã€æœç´¢ã€åˆ†é¡µã€è‡ªå®šä¹‰æ“ä½œç­‰å¤æ‚è¡Œä¸ºæ—¶ã€‚"]
) %>

<div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg">
  <div class="flex items-center justify-between">
    <div>
      <h4 class="font-semibold text-blue-900 mb-1">ğŸš€ å®Œæ•´äº¤äº’ç¤ºä¾‹</h4>
      <p class="text-sm text-blue-700">æŸ¥çœ‹å¸¦æœ‰æ’åºã€ç­›é€‰å’Œè¡Œé€‰æ‹©çš„å®Œæ•´å¯äº¤äº’ç¤ºä¾‹</p>
    </div>
    <%= link_to table_demo_path, 
                class: "px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium" do %>
      æŸ¥çœ‹å®é™…ç¤ºä¾‹ â†’
    <% end %>
  </div>
</div>

<% 
   user_struct = Struct.new(:id, :name, :role, :status, :email, :phone, :address)
   users = [
     user_struct.new(1, "John Brown", "Developer", :success, "john@example.com", "123-456-7890", "New York No. 1 Lake Park"),
     user_struct.new(2, "Jim Green", "Designer", :processing, "jim@example.com", "234-567-8901", "London No. 1 Lake Park")
   ]
%>

<%= render Ui::ExampleComponent.new(
  title: "åŸºç¡€è¡¨æ ¼ DSL",
  description: "ä½¿ç”¨ Block DSL å®šä¹‰åˆ—ã€‚æ”¯æŒè‡ªå®šä¹‰ HTML å†…å®¹ã€‚",
  language: :erb,
  code: table_basic_code
) do %>
  <%= ant_table(users) do |t| %>
     <% t.column "ID", class: "w-20" do |u| %>
       <%= u.id %>
     <% end %>
     <% t.column "Name" do |u| %>
       <div class="font-medium"><%= u.name %></div>
     <% end %>
     <% t.column "Tags" do |u| %>
       <%= ant_tag u.role %>
       <%= ant_tag "Nice", color: u.status %>
     <% end %>
     <% t.column "Action", class: "text-blue-600" do |u| %>
       <a>Invite <%= u.name %></a>
     <% end %>
  <% end %>
<% end %>

<%= render Ui::ExampleComponent.new(
  title: "è‡ªåŠ¨æ¨æ–­åˆ— (Auto Columns)",
  description: "æ‡’äººæ¨¡å¼ï¼šå¦‚æœæœªä¼ å…¥ blockï¼Œç»„ä»¶å°†è‡ªåŠ¨æ ¹æ®ç¬¬ä¸€æ¡æ•°æ®æ¨æ–­åˆ—åå¹¶æ¸²æŸ“ã€‚æ”¯æŒ ActiveRecord, Struct å’Œ Hashã€‚",
  language: :erb,
  code: table_auto_code
) do %>
  <% simple_users = users.map { |u| { id: u.id, name: u.name, role: u.role } } %>
  <%= ant_table(simple_users) %>
<% end %>

<% 
  current_page = (params[:page] || 1).to_i
  per_page = (params[:per_page] || 10).to_i
  all_large_users = (1..100).map do |i|
    user_struct.new(i, "User #{i}", "Role #{i}", :default, "user#{i}@example.com", "555-010#{i}", "Long Address Street No. #{i}, Some City, Some Country")
  end
  start_index = (current_page - 1) * per_page
  paged_users = all_large_users[start_index, per_page] || []
  total_count = all_large_users.size
%>

<%= render Ui::ExampleComponent.new(
  title: "é«˜çº§ç‰¹æ€§ï¼šå›ºå®šè¡¨å¤´ã€åˆ—å›ºå®šä¸åˆ†é¡µ",
  description: "æ”¯æŒ sticky_header, sticky: :left/:right ä»¥åŠåˆ†é¡µæ’æ§½ã€‚æ¨ªå‘æ»šåŠ¨æŸ¥çœ‹å›ºå®šåˆ—æ•ˆæœã€‚",
  language: :erb,
  code: table_advanced_code
) do %>
  <div class="w-full max-w-[800px]">
    <%= ant_table(paged_users, sticky_header: true, paginate: ant_pagination(current_page: current_page, total_count: total_count, per_page: per_page)) do |t| %>
       <% t.column "ID", sticky: :left, class: "w-20 font-mono text-center border-r border-gray-200" do |u| %>
         <%= u.id %>
       <% end %>
       <% t.column "Name", class: "w-48 font-medium" do |u| %>
         <%= u.name %>
       <% end %>
       <% t.column "Email", class: "w-56" do |u| %>
         <%= u.email %>
       <% end %>
       <% t.column "Phone", class: "w-40" do |u| %>
         <%= u.phone %>
       <% end %>
       <% t.column "Address (Long Content)", class: "w-[400px]" do |u| %>
         <%= u.address %>
       <% end %>
       <% t.column "Action", sticky: :right, class: "w-24 text-center border-l border-gray-200" do |u| %>
         <a href="#" class="text-blue-600 font-medium">Edit</a>
       <% end %>
    <% end %>
  </div>
<% end %>

<%
  # ç”Ÿæˆä¸°å¯Œçš„ä¼ªæ•°æ®ç”¨äºæ’åºå’Œç­›é€‰æ¼”ç¤º
  names = ["Alice Wang", "Bob Chen", "Carol Liu", "David Zhang", "Eve Li", "Frank Wu", 
           "Grace Xu", "Henry Zhou", "Iris Wang", "Jack Liu", "Kelly Chen", "Leo Zhang",
           "Mary Li", "Nancy Wu", "Oscar Xu", "Peter Wang", "Quinn Chen", "Rose Liu",
           "Steve Zhang", "Tina Li", "Uma Wu", "Victor Xu", "Wendy Wang", "Xavier Chen"]
  
  sortable_users = names.each_with_index.map do |name, i|
    roles = ["Developer", "Designer", "Manager"]
    statuses = [:success, :processing, :error]
    user_struct.new(
      i + 1, 
      name, 
      roles[i % 3], 
      statuses[i % 3], 
      "#{name.split.first.downcase}@example.com",
      "555-#{1000 + i}",
      "Address #{i + 1}"
    )
  end
%>

<%= render Ui::ExampleComponent.new(
  title: "æ’åºã€ç­›é€‰ä¸è¡Œé€‰æ‹©ï¼ˆå¯äº¤äº’ï¼‰",
  description: "è¿™æ˜¯ä¸€ä¸ªå®Œå…¨å¯äº¤äº’çš„ç¤ºä¾‹ã€‚ç‚¹å‡»åˆ—æ ‡é¢˜æ’åºï¼Œç‚¹å‡»ç­›é€‰å›¾æ ‡ç­›é€‰ï¼Œå‹¾é€‰å¤é€‰æ¡†é€‰æ‹©è¡Œã€‚æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹äº‹ä»¶è¯¦æƒ…ã€‚",
  language: :erb,
  code: table_sortable_code
) do %>
  <div data-controller="table-demo" data-table-demo-initial-data-value="<%= sortable_users.to_json %>">
    <div class="mb-4 flex items-center gap-4">
      <div class="text-sm text-gray-600">
        <span class="font-semibold">æ€»è®¡:</span> <span data-table-demo-target="totalCount"><%= sortable_users.size %></span> æ¡
      </div>
      <div class="text-sm text-gray-600" data-table-demo-target="filterInfo">
        <span class="font-semibold">ç­›é€‰:</span> æ— 
      </div>
      <div class="text-sm text-gray-600" data-table-demo-target="sortInfo">
        <span class="font-semibold">æ’åº:</span> æ— 
      </div>
    </div>
    
    <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
    <div data-table-demo-target="toolbar" 
         class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
      <div class="flex items-center gap-3">
        <span class="text-sm font-semibold text-blue-900" data-table-demo-target="selectionInfo">
          å·²é€‰æ‹© 0 é¡¹
        </span>
        <button class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
                data-action="click->table-demo#batchDelete">
          æ‰¹é‡åˆ é™¤
        </button>
        <button class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                data-action="click->table-demo#batchExport">
          æ‰¹é‡å¯¼å‡º
        </button>
      </div>
    </div>

    <div data-table-demo-target="tableContainer">
      <%= ant_table(sortable_users, 
                    row_selection: { get_row_key: ->(user) { user.id } }) do |t| %>
         <% t.column "ID", class: "w-16 font-mono", sortable: true do |u| %>
           <%= u.id %>
         <% end %>
         <% t.column "Name", class: "font-medium", sortable: true do |u| %>
           <%= u.name %>
         <% end %>
         <% t.column "Role", filterable: true, filters: [
              { text: "Developer", value: "Developer" },
              { text: "Designer", value: "Designer" },
              { text: "Manager", value: "Manager" }
            ] do |u| %>
           <%= ant_tag u.role %>
         <% end %>
         <% t.column "Status", filterable: true, filters: [
              { text: "Success", value: "success" },
              { text: "Processing", value: "processing" },
              { text: "Error", value: "error" }
            ] do |u| %>
           <%= ant_tag "Active", color: u.status %>
         <% end %>
         <% t.column "Email", class: "text-sm text-gray-600" do |u| %>
           <%= u.email %>
         <% end %>
         <% t.column "Action", class: "text-blue-600" do |u| %>
           <a href="#" class="hover:underline">ç¼–è¾‘</a>
         <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<%= render Ui::ExampleComponent.new(
  title: "åŠ è½½çŠ¶æ€",
  description: "æ˜¾ç¤ºåŠ è½½ä¸­çš„çŠ¶æ€ã€‚",
  language: :erb,
  code: table_loading_code
) do %>
  <%= ant_table(users, loading: true) do |t| %>
     <% t.column "ID", class: "w-20" do |u| %>
       <%= u.id %>
     <% end %>
     <% t.column "Name" do |u| %>
       <%= u.name %>
     <% end %>
     <% t.column "Role" do |u| %>
       <%= ant_tag u.role %>
     <% end %>
  <% end %>
<% end %>

<%= render Ui::ExampleComponent.new(
  title: "ç©ºçŠ¶æ€",
  description: "å½“æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€ã€‚",
  language: :erb,
  code: table_empty_code
) do %>
  <%= ant_table([], empty_text: "æš‚æ— æ•°æ®") do |t| %>
     <% t.column "ID" do |u| %>
       <%= u.id %>
     <% end %>
     <% t.column "Name" do |u| %>
       <%= u.name %>
     <% end %>
  <% end %>
<% end %>

<h3 class="text-xl font-bold text-gray-800 mb-4 mt-12 border-b pb-2 text-pink-600">API</h3>
<%= render Ui::ApiTableComponent.new do |api| %>
  <% api.row "collection", "è¦æ¸²æŸ“çš„æ•°æ®é›†åˆ (Enumerable)", "Array | ActiveRecord::Relation", "required" %>
  <% api.row "sticky_header", "æ˜¯å¦å¼€å¯å›ºå®šè¡¨å¤´ã€‚å¼€å¯åè¡¨æ ¼é«˜åº¦å›ºå®šå¹¶æ”¯æŒçºµå‘æ»šåŠ¨", "Boolean", "false" %>
  <% api.row "loading", "æ˜¯å¦æ˜¾ç¤ºåŠ è½½çŠ¶æ€", "Boolean", "false" %>
  <% api.row "empty_text", "ç©ºçŠ¶æ€æç¤ºæ–‡å­—", "String", "\"No Data\"" %>
  <% api.row "row_selection", "è¡Œé€‰æ‹©é…ç½®ã€‚ä¼ å…¥ { get_row_key: lambda } æ¥æŒ‡å®šè¡Œçš„å”¯ä¸€æ ‡è¯†", "Hash", "nil" %>
  <% api.row "paginate", "åˆ†é¡µå†…å®¹æ’æ§½ã€‚é€šå¸¸é…åˆ `ant_pagination` ä½¿ç”¨", "HTML String | Component", "nil" %>
  <% api.row "class", "å¤–å±‚å®¹å™¨è‡ªå®šä¹‰ CSS ç±»", "String", "nil" %>
<% end %>

<h4 class="font-bold text-gray-700 mt-10 mb-4 flex items-center">
  <span class="bg-gray-100 px-2 py-1 rounded text-pink-600 font-mono mr-2">t.column</span> DSL å‚æ•°
</h4>
<%= render Ui::ApiTableComponent.new do |api| %>
  <% api.row "header", "åˆ—æ ‡é¢˜", "String", "required" %>
  <% api.row "sticky", "åˆ—å›ºå®šæ–¹å‘ã€‚å¼€å¯åæ¨ªå‘æ»šåŠ¨æ—¶è¯¥åˆ—å°†å›ºå®š", "Symbol (:left | :right)", "nil" %>
  <% api.row "sortable", "æ˜¯å¦æ”¯æŒæ’åºã€‚å¼€å¯ååˆ—æ ‡é¢˜å¯ç‚¹å‡»æ’åº", "Boolean", "false" %>
  <% api.row "filterable", "æ˜¯å¦æ”¯æŒç­›é€‰ã€‚éœ€é…åˆ filters å‚æ•°ä½¿ç”¨", "Boolean", "false" %>
  <% api.row "filters", "ç­›é€‰é€‰é¡¹æ•°ç»„ã€‚æ ¼å¼ï¼š[{ text: 'æ˜¾ç¤ºæ–‡æœ¬', value: 'å€¼' }]", "Array", "nil" %>
  <% api.row "class", "åˆ—ï¼ˆth/tdï¼‰çš„è‡ªå®šä¹‰ CSS ç±»", "String", "nil" %>
<% end %>

<h4 class="font-bold text-gray-700 mt-10 mb-4">äº‹ä»¶</h4>
<div class="bg-gray-50 p-4 rounded-lg">
  <div class="space-y-2 text-sm">
    <div><code class="px-2 py-1 bg-white rounded">ant--table:sort</code> - æ’åºäº‹ä»¶ï¼Œdetail: { column, direction }</div>
    <div><code class="px-2 py-1 bg-white rounded">ant--table:filter</code> - ç­›é€‰äº‹ä»¶ï¼Œdetail: { column, value }</div>
    <div><code class="px-2 py-1 bg-white rounded">ant--table:filterClear</code> - æ¸…é™¤ç­›é€‰äº‹ä»¶ï¼Œdetail: { column }</div>
    <div><code class="px-2 py-1 bg-white rounded">ant--table:selectionChange</code> - è¡Œé€‰æ‹©å˜åŒ–äº‹ä»¶ï¼Œdetail: { selectedRows }</div>
  </div>
</div>

<h4 class="font-bold text-gray-700 mt-10 mb-4">åå°äº¤äº’ç¤ºä¾‹</h4>
<div class="bg-gray-50 p-4 rounded-lg space-y-4">
  <div>
    <h5 class="font-semibold text-gray-800 mb-2">1. ä½¿ç”¨ Turbo Frame è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¨èï¼‰</h5>
    <pre class="bg-white p-3 rounded border text-xs overflow-x-auto"><code>&lt;!-- View: app/views/users/index.html.erb --&gt;
&lt;div data-controller="users-table"&gt;
  &lt;%= turbo_frame_tag "users_table" do %&gt;
    &lt;%= ant_table(@users, 
                  row_selection: { get_row_key: ->(u) { u.id } }) do |t| %&gt;
      &lt;% t.column "Name", sortable: true do |u| %&gt;
        &lt;%= u.name %&gt;
      &lt;% end %&gt;
      &lt;% t.column "Role", filterable: true, 
                   filters: [{ text: "Admin", value: "admin" }] do |u| %&gt;
        &lt;%= u.role %&gt;
      &lt;% end %&gt;
    &lt;% end %&gt;
  &lt;% end %&gt;
&lt;/div&gt;

&lt;!-- Controller: app/javascript/controllers/users_table_controller.js --&gt;
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  connect() {
    this.element.addEventListener("ant--table:sort", this.handleSort.bind(this))
    this.element.addEventListener("ant--table:filter", this.handleFilter.bind(this))
  }

  handleSort(event) {
    const { column, direction } = event.detail
    const url = new URL(window.location)
    url.searchParams.set('sort_column', column)
    url.searchParams.set('sort_direction', direction)
    Turbo.visit(url.toString(), { frame: "users_table" })
  }

  handleFilter(event) {
    const { column, value } = event.detail
    const url = new URL(window.location)
    url.searchParams.set(`filter_${column}`, value)
    Turbo.visit(url.toString(), { frame: "users_table" })
  }
}

# Backend: app/controllers/users_controller.rb
def index
  @users = User.all
  
  # åº”ç”¨æ’åº
  if params[:sort_column].present? && params[:sort_direction] != 'none'
    @users = @users.order("#{params[:sort_column]} #{params[:sort_direction]}")
  end
  
  # åº”ç”¨ç­›é€‰
  if params[:filter_Role].present?
    @users = @users.where(role: params[:filter_Role])
  end
  
  render partial: "users_table", locals: { users: @users } if turbo_frame_request?
end</code></pre>
  </div>

  <div>
    <h5 class="font-semibold text-gray-800 mb-2">2. ä½¿ç”¨ Fetch API æ‰‹åŠ¨æ›´æ–°</h5>
    <pre class="bg-white p-3 rounded border text-xs overflow-x-auto"><code>&lt;!-- Controller: app/javascript/controllers/users_table_controller.js --&gt;
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  static targets = ["container"]
  
  connect() {
    this.currentParams = { sort: {}, filters: {}, selectedIds: [] }
    this.setupEventListeners()
  }

  setupEventListeners() {
    this.element.addEventListener("ant--table:sort", this.handleSort.bind(this))
    this.element.addEventListener("ant--table:filter", this.handleFilter.bind(this))
    this.element.addEventListener("ant--table:filterClear", this.handleFilterClear.bind(this))
    this.element.addEventListener("ant--table:selectionChange", this.handleSelection.bind(this))
  }

  async handleSort(event) {
    const { column, direction } = event.detail
    this.currentParams.sort = { column, direction }
    await this.refreshTable()
  }

  async handleFilter(event) {
    const { column, value } = event.detail
    this.currentParams.filters[column] = value
    await this.refreshTable()
  }

  async handleFilterClear(event) {
    const { column } = event.detail
    delete this.currentParams.filters[column]
    await this.refreshTable()
  }

  handleSelection(event) {
    const { selectedRows } = event.detail
    this.currentParams.selectedIds = selectedRows
    console.log("å½“å‰é€‰ä¸­:", selectedRows)
    // å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæ‰¹é‡æ“ä½œï¼Œå¦‚åˆ é™¤ã€å¯¼å‡ºç­‰
  }

  async refreshTable() {
    const params = new URLSearchParams()
    
    // æ·»åŠ æ’åºå‚æ•°
    if (this.currentParams.sort.direction !== 'none') {
      params.append('sort_column', this.currentParams.sort.column)
      params.append('sort_direction', this.currentParams.sort.direction)
    }
    
    // æ·»åŠ ç­›é€‰å‚æ•°
    Object.entries(this.currentParams.filters).forEach(([key, value]) => {
      params.append(`filter_${key}`, value)
    })

    try {
      const response = await fetch(`/users?${params.toString()}`, {
        headers: {
          "Accept": "text/html",
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      
      if (response.ok) {
        const html = await response.text()
        this.containerTarget.innerHTML = html
      }
    } catch (error) {
      console.error("åˆ·æ–°è¡¨æ ¼å¤±è´¥:", error)
    }
  }
}</code></pre>
  </div>

  <div>
    <h5 class="font-semibold text-gray-800 mb-2">3. æ‰¹é‡æ“ä½œç¤ºä¾‹</h5>
    <pre class="bg-white p-3 rounded border text-xs overflow-x-auto"><code>&lt;div data-controller="users-batch"&gt;
  &lt;div class="mb-4" data-users-batch-target="toolbar" style="display: none;"&gt;
    &lt;%= ant_button "æ‰¹é‡åˆ é™¤", 
                   color: :danger,
                   data: { action: "click->users-batch#deleteSelected" } %&gt;
    &lt;%= ant_button "æ‰¹é‡å¯¼å‡º", 
                   data: { action: "click->users-batch#exportSelected" } %&gt;
    &lt;span data-users-batch-target="count"&gt;å·²é€‰æ‹© 0 é¡¹&lt;/span&gt;
  &lt;/div&gt;
  
  &lt;%= ant_table(@users, 
                row_selection: { get_row_key: ->(u) { u.id } }) do |t| %&gt;
    &lt;!-- åˆ—å®šä¹‰ --&gt;
  &lt;% end %&gt;
&lt;/div&gt;

&lt;!-- Controller: app/javascript/controllers/users_batch_controller.js --&gt;
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  static targets = ["toolbar", "count"]
  
  connect() {
    this.selectedIds = []
    this.element.addEventListener("ant--table:selectionChange", this.handleSelection.bind(this))
  }

  handleSelection(event) {
    this.selectedIds = event.detail.selectedRows
    
    // æ˜¾ç¤º/éšè—å·¥å…·æ 
    if (this.selectedIds.length > 0) {
      this.toolbarTarget.style.display = 'block'
      this.countTarget.textContent = `å·²é€‰æ‹© ${this.selectedIds.length} é¡¹`
    } else {
      this.toolbarTarget.style.display = 'none'
    }
  }

  async deleteSelected() {
    if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${this.selectedIds.length} é¡¹å—ï¼Ÿ`)) return
    
    try {
      const response = await fetch('/users/batch_delete', {
        method: 'DELETE',
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector("[name='csrf-token']").content
        },
        body: JSON.stringify({ ids: this.selectedIds })
      })
      
      if (response.ok) {
        Turbo.visit(window.location, { action: "replace" })
      }
    } catch (error) {
      console.error("åˆ é™¤å¤±è´¥:", error)
    }
  }

  async exportSelected() {
    const params = new URLSearchParams({ ids: this.selectedIds })
    window.location.href = `/users/export?${params.toString()}`
  }
}</code></pre>
  </div>
</div>
